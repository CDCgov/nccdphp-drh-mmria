#!/bin/bash

#yum update
#yum install -y git 

echo "---> Building application from source..."


#current_build=$(git rev-parse --short HEAD)

current_year=$(date +%y)
current_month=$(date +%m)
current_day=$(date +%d)



#/tmp/scripts/assemble



curl https://github.com/icuseven/MMRDS/commits/master | grep -E "commit/([0-9abcdef]{40})"  > commit_temp.txt

current_build=$(cat commit_temp.txt | head -n1 | cut -d "/" -f7  | awk '{print substr ($0, 0, 7)}')

echo "---> $current_year.$current_month.$current_day v($current_build)"

ls -la > commit_temp.txt


volumes=$(cat commit_temp.txt | grep -E ".")

echo $volumes

 #sed -e 's/<\%=version\%>/'$current_year'.'$current_month'.'$current_day' v('$current_build')/g' /workspace/_Footer.cshtml.bk  > /workspace/_Footer.cshtml && \


# cp /vagrant/source-code/mmria/mmria-server/Views/Shared/_Footer.cshtml /workspace/_Footer.cshtml.bk && \
# sed -e 's/<\%=version\%>/'$current_year'.'$current_month'.'$current_day' v('$current_build')/g' /workspace/_Footer.cshtml.bk  > /workspace/_Footer.cshtml && \
# cd /workspace/test-core && \
# rm -rf /workspace/test-core/app/* && \
# cp -rf /vagrant/source-code/mmria /workspace/test-core/app && \
# docker run --rm -it -e DOTNET_CLI_TELEMETRY_OPTOUT=1 -v /workspace/test-core/app:/app microsoft/dotnet:latest bash -c "dotnet publish /app/mmria/mmria-server/mmria-server.csproj -f netcoreapp2.1 -r rhel.7-x64 --self-contained true" && \
# rm -f  /workspace/test-core/app/mmria/mmria-server/bin/Debug/netcoreapp2.1/rhel.7-x64/publish/appsettings.json && cp appsettings.json   /workspace/test-core/app/mmria/mmria-server/bin/Debug/netcoreapp2.1/rhel.7-x64/publish/appsettings.json && \
# rm -f  /workspace/test-core/app/mmria/mmria-server/bin/Debug/netcoreapp2.1/rhel.7-x64/publish/Views/Shared/_Footer.cshtml && cp /workspace/_Footer.cshtml  /workspace/test-core/app/mmria/mmria-server/bin/Debug/netcoreapp2.1/rhel.7-x64/publish//Views/Shared/_Footer.cshtml && \
# cp /workspace/test-core/mmria-server.runtimeconfig.json  /workspace/test-core/app/mmria/mmria-server/bin/Debug/netcoreapp2.1/rhel.7-x64/publish/mmria-server.runtimeconfig.json && \
# echo "building docker file"
# docker build -t mmria_test .  

# && \
# docker stop mmria-test && docker rm mmria-test && \
# docker run --name mmria-test -d  --publish 8080:8080 \
# -e couchdb_url="http://172.17.0.1:5984" \
# -e export_directory="./workspace" \
# -e web_site_url="http://*:8080" \
# -e timer_user_name="mmrds" \
# -e timer_password="mmrds" \
# -e cron_schedule="0 */1 * * * ?" \
# mmria_test 

echo "finished"