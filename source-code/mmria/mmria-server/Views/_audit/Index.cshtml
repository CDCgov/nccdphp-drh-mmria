@using System.Security.Claims;
@model mmria.server.Controllers.Audit_View
@{
    Layout = "_LayoutBase";

    ViewBag.BreadCrumbs = true;

    var row_number = 0;

    HashSet<string> user_list = new();

    foreach (var item in Model.ls)
    {
        user_list.Add(item.user_name);
    }

    var userName = "";
    var is_installation_admin = false;

    if(User.Identity != null && User.Identity.IsAuthenticated)
    {
        userName = User.Identities.First(
        u => u.IsAuthenticated && 
        u.HasClaim(c => c.Type == ClaimTypes.Name)).FindFirst(ClaimTypes.Name).Value;

    }


    foreach(var role in User.Identities.First(u => u.IsAuthenticated &&  u.HasClaim(c => c.Type == ClaimTypes.Name)).Claims.Where(c=> c.Type == ClaimTypes.Role))
    {
        switch(role.Value)
        {
            case "installation_admin":
                is_installation_admin = true;
                break;
        }
    }
}

@section HeadScripts
{
  <script src="../scripts/_audit/index.js" type="text/javascript"></script>
}
<h1 class="h2" tabindex="-1">Case Audit</h1>
<h3>@Model.cv.last_name, @Model.cv.first_name</h3>
<p><strong>Record Id:</strong> @Model.cv.record_id</p>
<p><strong>Date Created:</strong> @Model.cv.date_created <strong>Created By:</strong> @Model.cv.created_by</p>
<p><strong>Date Last Updated:</strong> @Model.cv.date_last_updated <strong>Last Updated By:</strong> @Model.cv.last_updated_by</p>

<form method="get" action="/_audit/@Model.id">
<table>
    <tr>
        <th colspan=3 align="center">Filter</th>
    </tr>
    <tr>
        <th>
user name
    </th>
    <th>search text</th>
    <th>&nbsp;</th>
    </tr>
<tr>
    <td>
        <select id="user" name="user">
            @if(string.IsNullOrWhiteSpace(Model.user) || Model.user.ToUpper() == "ALL")
            {
                <option selected="">All</option>
            }
            else
            {
                <option>All</option>
            }
            
            @foreach (var item in user_list)
            {
                @if(!string.IsNullOrWhiteSpace(Model.user) && Model.user.ToUpper() == item.ToUpper())
                {
                     <option selected>@item</option>
                }
                else
                {
                     <option>@item</option>
                }
         
            }
        </select>
    </td>
    <td>
        @if(!string.IsNullOrWhiteSpace(Model.search_text)&& Model.search_text.ToUpper() == "ALL")
        {
            <input id="search_text" name="search_text" type="text" value="" />
        }
        else
        {
            <input id="search_text" name="search_text" type="text" value="@Model.search_text" />
        }
        
    </td>
    <td>
        <input id="apply_filter_button" type="Submit" value="apply filter"/>
        <input id="clear_filter_button" type="button" value="clear filter"/>

    </td>
</tr>
</table>
</form>
<br/>

<table border=1>
<tr bgcolor="#BBBBBB">
<th>date_created</th>
<th>user_name</th>
<th>abstractor action</th>
<th>mmria_path</th>
<th>old value</th>
<th>new value</th>
<th></th>
</tr>
@foreach (var item in Model.ls)
{
    @if
    (
        !string.IsNullOrWhiteSpace(Model.user) && 
        Model.user.ToUpper() != "ALL" &&
        Model.user.ToUpper() != item.user_name.ToUpper()
    )
    {
        continue;
    }

    foreach (var change in item.items)
    { 
        @if
        (
            !string.IsNullOrWhiteSpace(Model.search_text) && 
            Model.search_text.ToUpper() != "ALL" &&
            (
                change.dictionary_path.IndexOf(Model.search_text) < 0
            )
        )
        {
            continue;
        }
        
        row_number++;

        var bg = "";
        
        @if(row_number % 2 == 0)
        {
            bg = "#CCCCCC";

        }



        @if(row_number % 15 == 0)
        {
            <tr bgcolor="#BBBBBB">
            <th>date_created</th>
            <th>user_name</th>
            <th>abstractor action</th>
            <th>mmria_path</th>
            <th>old value</th>
            <th>new value</th>
            <th></th>
            </tr>
        }
       <tr bgcolor="@bg">
    
        <td>@change.date_created</td>
        <td>@change.user_name</td>
        <td>@item.note</td>
        <td>@change.dictionary_path</td>
        <td>
            @if(change.old_value?.Length> 30)
            {
                 @change.old_value.Substring(0, 30);
                 
            }
            else
            {
                 @change.old_value;
            }
            
        </td>
        <td>
            @if(change.new_value?.Length> 30)
            {
                @change.new_value.Substring(0, 30); 
            }
            else
            {
                @change.new_value;
            }
        </td>
        <td>[ <a href="#">more details</a> ]</td>
    </tr>

    }

}
</table>


