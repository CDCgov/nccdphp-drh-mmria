<link rel="import" href="../../bower_components/polymer/polymer.html">	

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-pouchdb/app-pouchdb-document.html">


<!-- Paper elements -->
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">


<!-- Configure your routes here -->
<!-- link rel="import" href="routing.html" -->


<!-- Add your elements here >
<link rel="import" href="../../styles/app-theme.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../elements/my-greeting/my-greeting.html">
<link rel="import" href="../../elements/my-list/my-list.html"-->

<link rel="import" href="../autopsy/mmrds-autopsy.html">
<link rel="import" href="../demographic/mmrds-demographic.html">
<link rel="import" href="../finding_comment_grid/mmrds-finding_comment_grid.html">
<link rel="import" href="../race/mmrds-race.html">
<link rel="import" href="../date/mmrds-date.html">
<link rel="import" href="../form/mmrds-form.html">
<link rel="import" href="../maternal-birth-certificate/mmrds-maternal-birth-certificate.html">
<link rel="import" href="../summary/mmrds-summary.html">
<link rel="import" href="../home-record/mmrds-home_record.html">
<link rel="import" href="../death-certificate/mmrds-death_certificate.html">
<link rel="import" href="../cause-of-death-grid/mmrds-cause_of_death_grid.html">
<link rel="import" href="../data-summary/data-summary.html">
<link rel="import" href="../yesno/mmrds-yesno.html">
<link rel="import" href="../infant-birth-certificate/mmrds-infant_birth_certificate.html">
<link rel="import" href="../infant-birth-certificate/mmrds-infant_birth_certificate_list.html">
<link rel="import" href="../infant-birth-certificate/mmrds-infant_birth_certificate_detail.html">
<link rel="import" href="../profile/mmrds-profile.html">
<link rel="import" href="../profile/mmrds-profile-login.html">
<link rel="import" href="../profile/mmrds-profile-loggedin.html">


<dom-module id="mmrds-app">
<template id="app">
	<iron-ajax id="metadata_ajax" url="" handle-as="json" last-response="{{data}}" on-response="handle_response"></iron-ajax>
	<app-location  route="{{route}}" use-hash-as-path></app-location>
	<app-route  route="{{route}}" pattern="/:category" data="{{categoryData}}" tail="{{categoryTail}}"></app-route>
	<app-route  route="{{categoryTail}}" pattern="/:id" data="{{IdentifierData}}" tail="{{IdentifierTail}}" active="{{IdentifierActive}}"></app-route>
	<mmrds-data-summary data="{{data}}" selected_record_id="{{IdentifierData.id}}"></mmrds-data-summary>
	
	<app-pouchdb-document id="currentdocumentid"
			db-name="mmrds"
			doc-id="{{IdentifierData.id}}"
			data="{{home_record}}">
	</app-pouchdb-document>
	
	
    <paper-drawer-panel id="paperDrawerPanel">
      <!-- Drawer Scroll Header Panel -->
      <paper-scroll-header-panel drawer fixed vertical>

        <!-- Drawer Toolbar -->
        <paper-toolbar id="drawerToolbar">
          <span class="menu-name">Menu</span>
        </paper-toolbar>
<!--div>route{{route}}</div>
<div>categoryTail{{categoryTail.path}}</div>
<div>categoryData{{categoryData.category}}</div>
<div>selected_record_id{{categoryData.id}}</div-->

        <!-- Drawer Content -->
        <paper-menu class="app-menu" attr-for-selected="data-route" selected="{{categoryData.category}}">
          <a data-route="home" href="#/home">
            <iron-icon icon="home"></iron-icon>
            <span>Home</span>
          </a><br/>
		 <div id="abstractor_menu" style="display:none">
			  <a data-route="summary" href="#/summary">
				<iron-icon icon="mail"></iron-icon>
				<span>Summary</span>
			  </a><br/>

			  <a data-route="home-record" href="#/home-record/{{IdentifierData.id}}">
				<iron-icon icon="mail"></iron-icon>
				<span>Home Record</span>
			  </a><br/>

			<a data-route="death-certificate" href="#/death-certificate/{{IdentifierData.id}}">
				<iron-icon icon="mail"></iron-icon>
				<span>Death Certificate</span>
			</a><br/>

			<a data-route="MaternalBirthCertificate" href="#/MaternalBirthCertificate/{{IdentifierData.id}}">
				<iron-icon icon="mail"></iron-icon>
				<span>Maternal Birth Certificate</span>
			</a><br/>

			<a data-route="InfantFetalBirthCertificate" href="#/InfantFetalBirthCertificate/{{IdentifierData.id}}/list">
				<iron-icon icon="mail"></iron-icon>
				<span>Infant/Fetal Birth Certificate</span>
			</a><br/>


			<a data-route="AutopsyReport" href="#/AutopsyReport/{{IdentifierData.id}}">
				<iron-icon icon="mail"></iron-icon>
				<span>Autopsy Report</span>
			</a><br/>


			<a data-route="PrenatalCare" href="#/PrenatalCare/{{IdentifierData.id}}">
				<iron-icon icon="mail"></iron-icon>
				<span>Prenatal Care Records</span>
			</a><br/>


			<a data-route="ERVisits" href="{{baseUrl}}ERVisits">
				<iron-icon icon="mail"></iron-icon>
				<span>ER Visits and Hospitalizations</span>
			</a><br/>


			<a data-route="OtherVisits" href="{{baseUrl}}OtherVisits">
				<iron-icon icon="mail"></iron-icon>
				<span>Other medical office visits</span>
			</a><br/>


			<a data-route="SocialPsychProfile" href="{{baseUrl}}SocialPsychProfile">
				<iron-icon icon="mail"></iron-icon>
				<span>Social and psychological profile</span>
			</a><br/>


			<a data-route="InformantInterviews" href="{{baseUrl}}InformantInterviews">
				<iron-icon icon="mail"></iron-icon>
				<span>Informant interviews</span>
			</a><br/>


			<a data-route="CommitteeReview" href="{{baseUrl}}CommitteeReview">
				<iron-icon icon="mail"></iron-icon>
				<span>Committee review</span>
			</a><br/>


			<a data-route="CoreSummary" href="{{baseUrl}}CoreSummary">
				<iron-icon icon="mail"></iron-icon>
				<span>Core Summary</span>
			</a><br/>
		</div>
		<a data-route="users" href="{{baseUrl}}users">
            <iron-icon icon="info"></iron-icon>
            <span>Users</span>
          </a><br/>

		<a data-route="contact" href="{{baseUrl}}contact">
			<iron-icon icon="mail"></iron-icon>
			<span>Contact</span>
        </a><br/>
		
		</paper-menu>
		<paper-button id="savecurrentrecordbutton"  onclick="SaveCurrentRecord()"raised>save current record</paper-button>
		<paper-button onclick="InitializeNewDB()" raised>InitializeNewDB</paper-button>
		
      </paper-scroll-header-panel>

      <!-- Main Area -->
      <paper-scroll-header-panel main id="headerPanelMain" condenses keep-condensed-header>
        <!-- Main Toolbar -->
        <paper-toolbar id="mainToolbar" class="tall">
          <paper-icon-button id="paperToggle" icon="menu" paper-drawer-toggle></paper-icon-button>

          <span class="space"></span>

          <!-- Toolbar icons -->
          <mmrds-profile id="mmrds_profile" auth_session="{{auth_session}}" user_name="{{user_name}}" user_roles="{{user_roles}}"></mmrds-profile>
          

          <!-- Application name -->
          <div class="middle middle-container">
            <div class="app-name">MMRDS</div>
			<div>[[categoryData.category]] - [[home_record.first_name]] [[home_record.last_name]] [[home_record.record_id]]</div>
          </div>

          <!-- Application sub title -->
          <div class="bottom bottom-container">
            <div class="bottom-title">Maternal Mortality Review and Data System</div>
          </div>
        </paper-toolbar>

        <!-- Main Content -->
        <div class="content">
          <iron-pages id="page_set" attr-for-selected="data-route" selected="[[categoryData.category]]">
            <section data-route="home" tabindex="-1">
              <paper-material elevation="1">
			  <h1 class="page-title" tabindex="-1">Welcome to MMRDS</h1>
			  <p>The Maternal Mortality Review and Data System (MMRDS) is a software tool created by CDC to collect, store, analyze and summarize information relevant to maternal deaths. The MMRDS serves 2 purposes: first to provide complete, detailed, and organized medical and social information that can be used by medical review committees to investigate individual maternal deaths; and second to provide a standardized cumulative database for future research and analysis on maternal mortality.</p>
				</paper-material>
            </section>

            <section data-route="users" tabindex="-1">
              <paper-material elevation="1">
                <h1 class="page-title" tabindex="-1">Users</h1>
                <p>This is the users section</p>
                <a href$="{{baseUrl}}users/Addy">Addy</a><br>
                <a href$="{{baseUrl}}users/Rob">Rob</a><br>
                <a href$="{{baseUrl}}users/Chuck">Chuck</a><br>
                <a href$="{{baseUrl}}users/Sam">Sam</a>
              </paper-material>
            </section>

            <section data-route="user-info" tabindex="-1">
              <paper-material elevation="-1">
                <h1 class="page-title" tabindex="-1">User: {{params.name}}</h1>
                <div>This is {{params.name}}'s section</div>
              </paper-material>
            </section>

            <section data-route="contact" tabindex="-1">
              <paper-material elevation="1">
                <h1 class="page-title" tabindex="-1">contact</h1>
                <p>This is the contact section</p>
              </paper-material>
            </section>
			
            <section data-route="summary" tabindex="-1">
              <paper-material elevation="1">
                <h1 class="page-title" tabindex="-1">summary</h1>
			  
				<mmrds-summary data="[[data]]"></mmrds-summary>
			  
			  </paper-material>
            </section>


            <section data-route="home-record" tabindex="-1">
			<h1 class="page-title" tabindex="-1">home record</h1>
				<mmrds-home_record home_record="{{home_record}}"></mmrds-home_record>
            </section>
			
			<section data-route="death-certificate" tabindex="-1">
			<h1 class="page-title" tabindex="-1">death certificate</h1>
				<mmrds-death_certificate home_record="{{home_record}}"  death_certificate="{{home_record.death_certificate}}"></mmrds-death_certificate>
            </section>

			<section data-route="MaternalBirthCertificate" tabindex="-1">
			<h1 class="page-title" tabindex="-1">maternal birth certificate</h1>
				<mmrds-maternal-birth-certificate home_record="{{home_record}}" bound_data="{{home_record.maternal_birth_certificate}}"> </mmrds-maternal-birth-certificate>
            </section>


			<section data-route="InfantFetalBirthCertificate" tabindex="-1">
				<mmrds-infant_birth_certificate route="{{IdentifierTail}}" home_record="{{home_record}}" bound_data="{{home_record.infant_birth_fetal_death_certificate}}"></mmrds-infant_birth_certificate>
            </section>


			<section data-route="AutopsyReport" tabindex="-1">
				<mmrds-autopsy home_record="{{home_record}}" bound_data="{{home_record.autopsy}}"></mmrds-autopsy>
            </section>



			<section data-route="ERVisits" tabindex="-1">

            </section>

			<section data-route="OtherVisits" tabindex="-1">

            </section>

			<section data-route="SocialPsychProfile" tabindex="-1">

            </section>

			<section data-route="InformantInterviews" tabindex="-1">

            </section>

			<section data-route="CommitteeReview" tabindex="-1">

            </section>

			<section data-route="CoreSummary" tabindex="-1">

            </section>
			
          </iron-pages>
        </div>
      </paper-scroll-header-panel>
    </paper-drawer-panel>

    <paper-toast id="toast">
      <span class="toast-hide-button" role="button" tabindex="0" onclick="app.$.toast.hide()">Ok</span>
    </paper-toast>


</template>

<script>
	
//http://stackoverflow.com/questions/30615549/data-binding-in-a-dynamically-inserted-polymer-element
Polymer(
{
	is: 'mmrds-app',
	properties: 
	{ 
		
		data: 
		{
			type: Array,
			notify: true
		},
		selected_record_id:
		{
			type:String,
			notify:true,
			//value: function() { return ''; },
			observer: 'onSelectedRecordIdChanged'
		}
	},
	ready: function ()
	{
		var httpRequest = null;
		var ready_this = this;
		//https://developer.mozilla.org/en-US/docs/AJAX/Getting_Started
		// Old compatibility code, no longer needed.
		if (window.XMLHttpRequest) 
		{ // Mozilla, Safari, IE7+ ...
			httpRequest = new XMLHttpRequest();
		}
		else if (window.ActiveXObject) 
		{ // IE 6 and older
			httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
		}

		httpRequest.onreadystatechange = function()
		{
			
			if (httpRequest.readyState === XMLHttpRequest.DONE) 
			{
				// everything is good, the response is received
				if (httpRequest.status === 200) 
				{
					// perfect!
							// process the server response
					var parent = null;
					var metadata = JSON.parse(httpRequest.responseText);
					
					ready_this.CreateFromMetaData(document, ready_this, metadata, parent);

				}
				else 
				{
					// there was a problem with the request,
					// for example the response may contain a 404 (Not Found)
					// or 500 (Internal Server Error) response code
				}
			} 
			else 
			{
				// still not ready
			}
			
		};
		
		
		// var prenatal =  app.querySelector('section[data-route="PrenatalCare"]');
		// var myElement = document.createElement("mmrds-race");
		// prenatal.appendChild(myElement);
		// myElement = document.createElement("h1");
		// myElement.innerHTML = "bedrock";
		// prenatal.appendChild(myElement);
		httpRequest.open('GET', 'http://localhost:12345/meta-data/00/prenata_care.json', true);
		httpRequest.send(null);
	  
	},
	handle_response: function (e) 
	{
		console.log("handle_response done.");
	},
	addNewCase: function()
	{
		var new_data = [];
		
		for(var i in g_data)
		{
			new_data.push(g_data[i]);
		}
		
		var new_record_id = new Date().toISOString();
		new_data.push
		(
			{
				_id : new_record_id,
				date_created: new Date().toISOString(),
				created_by: 'jhaines',
				date_last_updated: new Date().toISOString(),
				last_updated_by: 'jhaines',
				record_id : '',
				first_name : 'New First',
				middle_name : '',
				last_name : 'New Last',
				date_of_death : '2000-01-01',
				state_of_death : '',
				state_of_last_known_residence : '',
				agency_case_id : '',
				is_valid_maternal_mortality_record : false,
				death_certificate:
				{ 
					causes_of_death:[], 
					place_of_last_residence:
					{  
						street:"123 Old US HWY 25",
						city:"Los Angeles",
						state:"California",
						zip_code:"900890255"
					} 
				}
			}
		);
		
		g_data = new_data;
		
		this.data = g_data;
		g_selected_record_id = new_record_id;
		g_selected_record_index = g_data.length -1;
	},
	onSelectedRecordIdChanged: function(e)
	{
		if(e && e.currentTarget)
		{
			console.log('onSelectedRecordIdChanged' + e.currentTarget.dataValue)
			this.selected_record_id = e.currentTarget.dataValue;
		}
	},
	CreateFromMetaData: function (document, app, metadata, parent)
	{
		
		var a = null;
		var element = null;
		var h1 = null;
		var element_2 = null;
		var element_3 = null;
		
		if(metadata.type)
		{
			switch(metadata.type.toLowerCase())
			{
				case 'string':
					//<paper-input label="In prior 3 months (# of cigarettes/ packs)" value="{{bound_data.cigarette_smoking.prior_3_months}}"></paper-input>
	
	
					element = document.createElement("paper-input");
					a = document.createAttribute("label");
					a.value = metadata.prompt;
					element.setAttributeNode(a);
					
					
					a = document.createAttribute("value");
					a.value = "{{bound_data." + metadata.name + "}}";
					element.setAttributeNode(a);
					
					parent.appendChild(element);
					break;			
			
				case 'form':
					var page_set =  app.querySelector('#page_set');
					var section = document.createElement("section");
					
					a = document.createAttribute("data-route");
					a.value = metadata.data_route;
					section.setAttributeNode(a);
					
					a  = document.createAttribute("tabindex");
					a.value = "-1";
					section.setAttributeNode(a);
					
					a  = document.createAttribute("class");
					a.value = "style-scope mmrds-app";
					section.setAttributeNode(a);
					
					h1 = document.createElement("h1");
					h1.innerHTML = metadata.prompt;
					section.appendChild(h1);
				
					Polymer.dom(page_set).appendChild(section);
					
					for(var i = 0; i < metadata.children.length; i++)
					{
						var child = metadata.children[i];
						this.CreateFromMetaData(document, app, child, section)
					}

					break;
				case 'group'://<paper-material elevation="1">
					element = document.createElement("paper-material");
					a  = document.createAttribute("elevation");
					a.value = "1";
					element.setAttributeNode(a);
					
					h1 = document.createElement("h1");
					h1.innerHTML = metadata.prompt;
					element.appendChild(h1);

					parent.appendChild(element);

					for(var i = 0; i < metadata.children.length; i++)
					{
						var child = metadata.children[i];
						this.CreateFromMetaData(document, app, child, element)
					}
					
					break;
				case 'radio':
					//<paper-input label="In prior 3 months (# of cigarettes/ packs)" value="{{bound_data.cigarette_smoking.prior_3_months}}"></paper-input>
					//<paper-radio-group selected="{{bound_data.cigarette_smoking.prior_3_months_type}}">
					
					h1 = document.createElement("h2");
					h1.innerHTML = metadata.prompt;
					parent.appendChild(h1);
					
					element = document.createElement("paper-radio-group");
					a  = document.createAttribute("selected");
					a.value = "{{bound_data." + metadata.name + "}}";
					element.setAttributeNode(a);
					
					
					
					//<paper-radio-button name="">not specified</paper-radio-button>
					element_2 = document.createElement("paper-radio-button");
					element_2.innerHTML = "not specified";
					
					a = document.createAttribute("name");
					a.value = "";
					element_2.setAttributeNode(a);
					
					element.appendChild(element_2);
					
					
					for(var i = 0; i < metadata.values.length; i++)
					{
						var radio_value = metadata.values[i];
						
	
						element_2 = document.createElement("paper-radio-button");
						a = document.createAttribute("name");
						a.value = radio_value;
						element_2.setAttributeNode(a);
						element_2.innerHTML = radio_value;
						element.appendChild(element_2);
					}
					
					parent.appendChild(element);
					
					break;
				default:
					console.log(metadata.type);
					break;
				
			}
		}
		
		/*
		if(typeof i=='undefined')i='';
		if(i.length>50)return '[MAX ITERATIONS]';
		var r=[];
		for(var p in o)
		{
			var t=typeof o[p];
			r.push(i+'"'+p+'" ('+t+') => '+(t=='object' ? 'object:'+xinspect(o[p],i+'  ') : o[p]+''));
		}
		return r.join(i+'\n');*/
	}

});
	  
</script>
	
</dom-module>