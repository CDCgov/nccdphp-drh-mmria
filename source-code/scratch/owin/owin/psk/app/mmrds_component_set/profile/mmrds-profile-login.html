<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<dom-module id="mmrds-profile-login">
<template>
<iron-ajax id="ajax" url="" handle-as="json" last-response="{{data}}" on-response="handle_response"></iron-ajax>
<style>
      :host {
        display: none;
      }
      :host([active]) {
        display: block;
      }
</style>
user name: <input id="name" type="text" value="user1" />
password: <input id="password" type="password" value="password" />
<input type="button" value="login" on-tap="login" />
  
  <!--paper-icon-button icon="search"></paper-icon-button-->
  
  
</template>
<script>
Polymer({
	is: 'mmrds-profile-login',
	properties: 
	{
		active: 
		{
		  type: Boolean,
		  value: true,
		  reflectToAttribute: true
		},
		bound_data: 
		{ 
			type: String,
			notify: true
		},
		auth_session: { type: String },
		user_name: { type: String },
		user_roles: { type: Array }
	},
	login: function()
	{
		
		if
		(
			this.$.name.value.length > 0 &&
			this.$.password.value.length > 0
		)
		{
		
			this.$.ajax.url = "http://localhost:12345/api/session";
			this.$.ajax.params = {
					userid: this.$.name.value,
					password: this.$.password.value
			};
			this.$.ajax.generateRequest();
		}

	},
	handle_response: function(request) 
	{
		var valid_login = false;
		
	
		var json_response = request.detail.response[0];
		this.user_name = json_response.name;
		this.user_roles = json_response.roles
		this.auth_session = json_response.auth_session;

		console.log(request.detail.response);
		
		//document.cookie = "username=John Doe; expires=Thu, 18 Dec 2013 12:00:00 UTC";
		var minutes_14 = 14;
		var current_date_time = new Date();
		var new_date_time = new Date(current_date_time.getTime() + minutes_14 * 60000);
		
		document.cookie = "auth_session=" + json_response.auth_session + "; expires=" + new_date_time.toISOString() + ";";
		
		//console.log(this.$.ajax.lastResponse);
		//{"ok":true,"userCtx":{"name":null,"roles":[]},"info":{"authentication_db":"_users","authentication_handlers":["oauth","cookie","default"]}}
		//http://stackoverflow.com/questions/34042408/polymerjs-iron-ajax-how-to-bind-token-to-headers-property
		
		valid_login = this.user_name != null;
		if(valid_login)
		{
			this.fire('profile_login_changed', { 
				is_logged_in: true, 
				user_name: this.user_name,
				user_roles: this.user_roles,
				auth_session: this.auth_session,
			});
		}
		
	}
});
	  
	  
</script>
	
</dom-module>